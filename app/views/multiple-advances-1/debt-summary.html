{% import "includes/multiple-advances-1/_globals.html" as globals %}
{% set totalBalance = 0 %}
{% set totalRepaid = 0 %}
{% set totalOwed = 0 %}
{% set repaidRowsTotal = 0 %}


{% set debtRows = [] %}

{% for debt in globals.debts %}
  {% set debtRows = (debtRows.push(
    [{
      html: '<a href="debt-details.html?id=' + (loop.index - 1) + '" class="govuk-link">' + debt.description + '</a>' 
    },
    {
      text: "£" + debt.balance.toFixed(2),
      format: "numeric"
    },
    {
      text: "£" + debt.repaid.toFixed(2),
      format: "numeric"
    },
    {
      text: "£" + (debt.balance - debt.repaid).toFixed(2),
      format: "numeric"
    ]}), debtRows) %}

  {% set totalBalance = totalBalance + debt.balance %}
  {% set totalRepaid = totalRepaid + debt.repaid %}
{% endfor %}

{% set totalOwed = totalBalance - totalRepaid %}



{% set repaymentRows = [] %}

{% for repayment in globals.repayments %}
  {% set repaymentRows = (repaymentRows.push(
    [{
      text: repayment.date 
    },
    {
      html: '<a href="repayment-details.html?id=' + loop.index + '" class="govuk-link">' + repayment.description + '</a>' 
    },
    {
      text: "£" + ( totalRepaid/globals.repayments.length ).toFixed(2),
      format: "numeric"
    ]}), repaymentRows) %}

    {% set repaidRowsTotal = repaidRowsTotal + totalRepaid/globals.repayments.length %}
{% endfor %}



{% extends "layout_unbranded.html" %}



{# {% block beforeContent %}
  {{ govukBackLink({
    text: "Back",
    href: "#"
  }) }}
{% endblock %} #}

{% block content %}

{% if repaidRowsTotal != totalRepaid %}
  {{govukTag({
          text: "TODO: Repaid does not total",
          classes: "govuk-tag--red"
        })}}
{% endif %}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
 
      {% include "includes/multiple-advances-1/citizen-header.html" %}

      <section class="section">
        <h2 class="govuk-heading-m">
          Debt overview
        </h2>
        <dl class="govuk-clearfix govuk-section-break--l key-values ">
          <div class="key-values-col govuk-grid-column-one-third">
            <dt class="govuk-caption-m govuk-!-margin-bottom-0">Total balance</dt>
            <dd class="govuk-heading-l govuk-!-margin-left-0">£{{ totalBalance.toFixed(2) }}</dd>
          </div>
          <div class="key-values-col govuk-grid-column-one-third">
            <dt class="govuk-caption-m govuk-!-margin-bottom-0">Total repaid</dt>
            <dd class="govuk-heading-l govuk-!-margin-left-0">£{{ totalRepaid.toFixed(2)  }}</dd>
          </div>
          <div class="key-values-col govuk-grid-column-one-third">
            <dt class="govuk-caption-m govuk-!-margin-bottom-0">Total owed</dt>
            <dd class="govuk-heading-l govuk-!-margin-left-0">£{{ totalOwed.toFixed(2)  }}</dd>
          </div>
        </dl>

        <div class="govuk-clearfix govuk-!-margin-top-5">
          <h2 class="card-title govuk-heading-m govuk-!-font-weight-regular">
            Debts ({{ globals.debts.length }})
          </h2>

          {{ govukTable({
            classes: "",
            firstCellIsHeader: false,
            
            head: [
              {
                text: "Description"
              },
              {
                text: "Original balance",
                format: "numeric"
              },
              {
                text: "Amount repaid",
                format: "numeric"
              },
              {
                text: "Amount owed",
                format: "numeric"
              }

            ],

            rows: debtRows
          }) }}
        </div>
      </section>


      <section class="govuk-!-margin-bottom-2">
        <h2 class="card-title govuk-heading-m govuk-!-font-weight-regular">
          Repayment history
        </h2>

        {{ govukTable({
            classes: "",
            firstCellIsHeader: false,
            
            head: [
              {
                text: "Date"
              },
              
              {
                text: "Repayment Method"
              },
              {
                text: "Amount",
                format: "numeric"
              }
            ],

            rows: repaymentRows
          }) }}
        </section>
    </div>
    
  </div>

{% endblock %}